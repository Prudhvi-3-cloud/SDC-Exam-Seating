// Prisma schema for SRIT exam seating prototype

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ExamType {
  MID
  SEM
}

enum PortalRole {
  ADMIN
  FACULTY
  STUDENT
}

model Student {
  id        String   @id @default(cuid())
  rollNo    String   @unique
  name      String
  dept      String
  year      Int
  email     String
  createdAt DateTime @default(now())

  sessionStudents SessionStudent[]
  assignments     SeatingAssignment[]
  outboxEmails    OutboxEmail[]
}

model Room {
  id            String   @id @default(cuid())
  block         String
  roomNo        String
  benches       Int
  seatsPerBench Int      @default(2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  sessionRooms SessionRoom[]
  assignments  SeatingAssignment[]
  invigilators SessionInvigilator[]
}

model ExamSession {
  id        String   @id @default(cuid())
  examType  ExamType
  daysCount Int
  createdAt DateTime @default(now())

  sessionStudents SessionStudent[]
  sessionRooms    SessionRoom[]
  plans           SeatingPlan[]
  invigilators    SessionInvigilator[]
}

model SessionStudent {
  id        String @id @default(cuid())
  sessionId String
  studentId String

  session ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
}

model SessionRoom {
  id        String @id @default(cuid())
  sessionId String
  roomId    String

  session ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  room    Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([sessionId, roomId])
}

model SeatingPlan {
  id        String   @id @default(cuid())
  sessionId String
  dayIndex  Int
  version   Int
  seed      String
  createdAt DateTime @default(now())

  session     ExamSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  assignments SeatingAssignment[]
  outbox      OutboxEmail[]

  @@unique([sessionId, dayIndex, version])
}

model SeatingAssignment {
  id       String @id @default(cuid())
  planId   String
  studentId String
  roomId   String
  benchNo  Int
  seatNo   Int

  plan    SeatingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  student Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  room    Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@unique([planId, studentId])
  @@unique([planId, roomId, benchNo, seatNo])
}

model OutboxEmail {
  id        String   @id @default(cuid())
  planId    String
  studentId String
  toEmail   String
  subject   String
  body      String
  createdAt DateTime @default(now())

  plan    SeatingPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  student Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([planId, studentId])
}

model Department {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())

  sections        Section[]
  studentProfiles StudentProfile[]
  facultyProfiles FacultyProfile[]
}

model Section {
  id           String   @id @default(cuid())
  year         Int
  name         String
  departmentId String
  createdAt    DateTime @default(now())

  department      Department           @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  studentProfiles StudentProfile[]
  facultyAccess   FacultySectionAccess[]

  @@unique([departmentId, year, name])
}

model PortalUser {
  id         String     @id @default(cuid())
  email      String     @unique
  password   String
  role       PortalRole
  name       String
  isBlocked  Boolean    @default(false)
  createdAt  DateTime   @default(now())

  studentProfile StudentProfile?
  facultyProfile FacultyProfile?

  @@index([role])
}

model StudentProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  rollNo       String   @unique
  year         Int
  departmentId String
  sectionId    String
  createdAt    DateTime @default(now())

  user       PortalUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  department Department @relation(fields: [departmentId], references: [id])
  section    Section    @relation(fields: [sectionId], references: [id])

  @@index([departmentId, year, sectionId])
  @@index([rollNo])
}

model FacultyProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  departmentId String
  createdAt    DateTime @default(now())

  user          PortalUser           @relation(fields: [userId], references: [id], onDelete: Cascade)
  department    Department           @relation(fields: [departmentId], references: [id])
  sectionAccess FacultySectionAccess[]
  invigilationAssignments SessionInvigilator[]
}

model FacultySectionAccess {
  id               String   @id @default(cuid())
  facultyProfileId String
  sectionId        String

  facultyProfile FacultyProfile @relation(fields: [facultyProfileId], references: [id], onDelete: Cascade)
  section        Section        @relation(fields: [sectionId], references: [id])

  @@unique([facultyProfileId, sectionId])
}

model SessionInvigilator {
  id               String   @id @default(cuid())
  sessionId        String
  roomId           String
  facultyProfileId String
  createdAt        DateTime @default(now())

  session        ExamSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  room           Room          @relation(fields: [roomId], references: [id], onDelete: Cascade)
  facultyProfile FacultyProfile @relation(fields: [facultyProfileId], references: [id], onDelete: Cascade)

  @@unique([sessionId, roomId, facultyProfileId])
  @@index([sessionId])
  @@index([roomId])
  @@index([facultyProfileId])
}
